<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<title>Gravar Consulta Médica</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<style>
body{font-family:Arial;margin:0;background:#f5f5f5;padding:20px;}
#recordBtn{width:150px;height:150px;border-radius:50%;border:none;color:#fff;font-size:20px;cursor:pointer;}
#recordBtn.start{background:#28a745;}
#recordBtn.stop{background:#dc3545;}
textarea{width:100%;height:150px;margin-top:20px;}
.section{margin-top:30px;padding:20px;background:#fff;border-radius:10px;}
</style>
</head>
<body>

<h1>Gravação de Consulta Médica</h1>

<div class="section">
<button id="recordBtn" class="start">Iniciar</button>
<div id="timer" style="font-size:24px;margin-top:15px;">00:00</div>
<div id="micStatus" style="margin-top:10px;color:#666;">Aguardando...</div>

<textarea id="transcript" placeholder="Transcrição aparecerá aqui"></textarea>
</div>

<div class="section">
<h2>Resumo SOAP</h2>
<pre id="soapOutput" style="white-space:pre-wrap;"></pre>
<button id="generateSoapBtn">Gerar SOAP e Prescrição</button>
</div>

<div class="section">
<h2>Prescrição</h2>
<pre id="prescriptionOutput" style="white-space:pre-wrap;"></pre>
<button id="printBtn">Imprimir PDF</button>
</div>

<div id="area-impressao" style="display:none;">
<h2>Prescrição médica</h2>
<pre id="prescricaoImpressao"></pre>
</div>

<script>
let isRecording=false;
let recognition;
let finalTranscript="";
let timerInterval;
let startTime;

function initSpeech(){
 const SR=window.SpeechRecognition||window.webkitSpeechRecognition;
 if(!SR){document.getElementById("micStatus").innerText="Navegador não suporta voz.";return;}
 recognition=new SR();
 recognition.lang="pt-BR";
 recognition.continuous=true;
 recognition.interimResults=true;

 recognition.onresult=e=>{
   let interim="";
   for(let i=e.resultIndex;i<e.results.length;i++){
     const t=e.results[i][0].transcript;
     if(e.results[i].isFinal){finalTranscript+=t+" ";}
     else{interim+=t;}
   }
 document.getElementById("transcript").value=(finalTranscript+" "+interim).trim();
 };

 recognition.onerror=e=>{document.getElementById("micStatus").innerText="Erro: "+e.error;}
}

function startTimer(){
 startTime=Date.now();
 timerInterval=setInterval(()=>{
   const s=Math.floor((Date.now()-startTime)/1000);
   const m=("0"+Math.floor(s/60)).slice(-2);
   const ss=("0"+(s%60)).slice(-2);
   document.getElementById("timer").innerText=`${m}:${ss}`;
 },500);
}

function stopTimer(){clearInterval(timerInterval);}

document.getElementById("recordBtn").onclick=()=>{
 if(!recognition) initSpeech();
 if(!recognition) return;

 if(!isRecording){
   finalTranscript=document.getElementById("transcript").value+" ";
   recognition.start();
   isRecording=true;
   document.getElementById("micStatus").innerText="Gravando...";
   document.getElementById("recordBtn").className="stop";
   document.getElementById("recordBtn").innerText="Parar";
   startTimer();
 } else {
   recognition.stop();
   isRecording=false;
   document.getElementById("micStatus").innerText="Parado.";
   document.getElementById("recordBtn").className="start";
   document.getElementById("recordBtn").innerText="Iniciar";
   stopTimer();
 }
};

document.getElementById("generateSoapBtn").onclick=async()=>{
 const text=document.getElementById("transcript").value.trim();
 if(!text){alert("Transcrição vazia.");return;}

 document.getElementById("soapOutput").innerText="Gerando...";
 document.getElementById("prescriptionOutput").innerText="";

 try{
   const r=await fetch("https://SEU_BACKEND.onrender.com/api/gerar-soap",{
     method:"POST",
     headers:{"Content-Type":"application/json"},
     body:JSON.stringify({transcricao:text})
   });
   const data=await r.json();
   document.getElementById("soapOutput").innerText=data.soap||"Sem retorno";
   document.getElementById("prescriptionOutput").innerText=data.prescricao||"Sem retorno";
   document.getElementById("prescricaoImpressao").innerText=data.prescricao||"";
 }catch(e){
   document.getElementById("soapOutput").innerText="Erro.";
 }
};

document.getElementById("printBtn").onclick=()=>{
 window.print();
};
</script>

</body>
</html>
